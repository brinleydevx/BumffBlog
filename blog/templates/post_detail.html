{% extends "base.html" %}
{% block content %}

<div class="container post-detail">
    <article class="post-hero">
        <h1 class="post-title">{{ post.title }}</h1>

        <div class="post-meta-row">
            <div class="post-meta-left">
                <small class="muted">{{ post.date_created.strftime("%Y-%m-%d") }}</small>
                <span class="dot">â€¢</span>
                <a class="author-link" href="{{ url_for('main.user_profile', username=post.author.username) }}">
                    {% if post.author.profile_image %}
                        <img class="avatar" src="{{ url_for('static', filename='uploads/' ~ post.author.profile_image) }}" alt="{{ post.author.username }}">
                    {% endif %}
                    <strong>{{ post.author.username }}</strong>
                </a>
            </div>

            <div class="post-actions">
                {% if current_user.is_authenticated and post.author == current_user %}
                    <a class="btn btn-outline" href="{{ url_for('main.edit_post', id=post.id) }}">Edit</a>
                    <form method="POST" action="{{ url_for('main.delete_post', post_id=post.id) }}" style="display:inline;">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Delete this post?');">Delete</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </article>

    <div class="post-body card">
        {{ post.content }}
    </div>

    <section class="comments-section">
        <h3>Comments ({{ post.comments|length }})</h3>

        <div class="comment-form">
            {% if current_user.is_authenticated %}
                <form method="POST">
                    {{ form.hidden_tag() }}
                    {{ form.content(rows=3, class="input") }}
                    {{ form.parent_id() }}
                    <div class="form-actions">
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            {% else %}
                <p><a href="{{ url_for('main.login') }}">Login</a> to post a comment.</p>
            {% endif %}
        </div>

        <div class="comments-list">
            {% set top_comments = post.comments|selectattr('parent', 'equalto', None)|list %}
            {% if top_comments %}
                {% from "_comment.html" import render_comment %}
                {% for comment in top_comments %}
                    {{ render_comment(comment, form, current_user) }}
                {% endfor %}
            {% else %}
                <p>No comments yet.</p>
            {% endif %}
        </div>
    </section>

    <div style="margin-top:1.25rem">
        <a href="/home">Back to Posts</a>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.reply-link').forEach(function(el){
        el.addEventListener('click', function(e){
            e.preventDefault();
            var id = this.getAttribute('data-comment-id');
            var box = document.getElementById('reply-form-' + id);
            if(!box) return;
            box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'block' : 'none';
            var ta = box.querySelector('textarea'); if(ta) ta.focus();
        });
    });
});
</script>

<script src="{{ url_for('static', filename='js/comments.js') }}"></script>

{% endblock %}
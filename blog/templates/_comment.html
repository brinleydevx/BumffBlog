{% macro render_comment(comment, form, current_user, depth=0, max_visible_replies=5) %}
  {%- set indent = (depth * 1.25) -%}
  <div class="{{ 'comment reply' if comment.parent_id else 'comment' }}" id="comment-{{ comment.id }}" style="margin-left: {{ indent }}rem;">
    <div class="comment-head">
      <strong>{{ comment.author.username }}</strong>
      <small class="muted">{{ comment.date_created.strftime("%Y-%m-%d %H:%M") }}</small>
    </div>

    <div class="comment-body">{{ comment.content }}</div>

    <div class="comment-actions">
      {% if current_user and current_user.is_authenticated %}
        <a href="#" class="reply-link" data-comment-id="{{ comment.id }}">Reply</a>
      {% else %}
        <a href="{{ url_for('main.login') }}">Login to reply</a>
      {% endif %}

      <form method="POST" action="{{ url_for('main.like_comment', comment_id=comment.id) }}" style="display:inline;">
        {{ form.hidden_tag() }}
        <button type="submit" class="like-btn">‚ù§ {{ comment.likes_count }}</button>
      </form>

      {% if current_user and comment.author == current_user %}
        <a href="{{ url_for('main.delete_comment', id=comment.id) }}" onclick="return confirm('Delete comment?')">Delete</a>
      {% endif %}
    </div>

    {# render a limited number of replies and hide the rest behind a toggle #}
    {% set total_replies = comment.replies|length %}
    {% if total_replies > 0 %}
      {% set visible = comment.replies[:max_visible_replies] %}
      {% for reply in visible %}
        {{ render_comment(reply, form, current_user, depth+1, max_visible_replies) }}
      {% endfor %}

      {% if total_replies > max_visible_replies %}
        <div id="hidden-replies-{{ comment.id }}" style="display:none;">
          {% for reply in comment.replies[max_visible_replies:] %}
            {{ render_comment(reply, form, current_user, depth+1, max_visible_replies) }}
          {% endfor %}
        </div>
        <button class="btn btn-outline show-more-replies" data-target="hidden-replies-{{ comment.id }}">Show {{ total_replies - max_visible_replies }} more replies</button>
      {% endif %}
    {% endif %}

    <div class="reply-form" id="reply-form-{{ comment.id }}" style="display:none; margin-top:0.5rem;">
      <form method="POST">
        {{ form.hidden_tag() }}
        {{ form.content(rows=2, class="input") }}
        <input type="hidden" name="parent_id" value="{{ comment.id }}" />
        <div class="form-actions" style="margin-top:0.5rem;">
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
{% endmacro %}
